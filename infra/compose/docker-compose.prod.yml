services:
  web:
    image: new_project:latest
    expose:
      - "8000"
    ports:
      - "${APP_PORT:-8001}:8000"  # 直接對外（單獨跑 web 時有用；與 Caddy 並行也可保留）
    environment:
      - PYTHONUNBUFFERED=1
      - API_KEY=${API_KEY:-}
      - RATE_LIMIT_PER_MIN=200
    volumes:
      - ../../data:/app/data:rw
      - ../../models:/app/models:rw
    restart: unless-stopped
    networks:
      - webnet

  caddy:
    image: caddy:2-alpine
    depends_on:
      - web
    ports:
      - "80:80"
      - "443:443"
    environment:
      # 提供預設空值以避免未設置時的 Compose 告警
      - DOMAIN=${DOMAIN:-}
      - ACME_EMAIL=${ACME_EMAIL:-}
    volumes:
      - ../caddy/conf/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../caddy/data:/data
      - ../caddy/config:/config
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - webnet

  ddns:
    image: python:3.11-slim
    restart: unless-stopped
    profiles: ["ddns"]
    env_file:
      - ../../.env
    working_dir: /app
    volumes:
      - ../../scripts/ddns:/app:ro
    command:
      - sh
      - -c
      - set -e; python -m pip install -q requests; python -u ddns_updater.py
    networks:
      - webnet

networks:
  webnet:
    driver: bridge

# volumes:
#   - ../../data:/app/data:rw
#   - ../../models:/app/models:rw