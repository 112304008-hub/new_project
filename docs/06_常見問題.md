# 06 常見問題

## 安裝與環境

### Q1: `pip install` 失敗，提示無法找到 numpy 1.28.1

**症狀**：
```
ERROR: Could not find a version that satisfies the requirement numpy==1.28.1
```

**原因**：numpy 1.28.1 不存在，requirements.txt 配置錯誤。

**解決方案**：
```bash
# 修改 requirements.txt
numpy==1.26.4  # 改爲 1.26.4（最後一個 1.x 版本）

# 重新安裝
pip install -r requirements.txt
```

---

### Q2: 安裝 scipy 或 scikit-learn 時編譯失敗

**症狀**：
```
Building wheels for collected packages: scipy
ERROR: Failed building wheel for scipy
```

**原因**：缺少 C/C++ 編譯器或 BLAS/LAPACK 庫。

**解決方案（Windows）**：
```powershell
# 方法 1：使用預編譯的 wheel 檔案
pip install --upgrade pip
pip install scipy scikit-learn -i https://pypi.tuna.tsinghua.edu.cn/simple

# 方法 2：安裝 Microsoft C++ Build Tools
# 下載並安裝：https://visualstudio.microsoft.com/visual-cpp-build-tools/
```

**解決方案（Linux）**：
```bash
# Ubuntu/Debian
sudo apt-get install build-essential gfortran libopenblas-dev liblapack-dev

# CentOS/RHEL
sudo yum install gcc gcc-gfortran openblas-devel lapack-devel

# 然後重新安裝
pip install -r requirements.txt
```

---

### Q3: ImportError: DLL load failed

**症狀**：
```python
import sklearn
ImportError: DLL load failed while importing _arpack: 找不到指定的模塊。
```

**原因**：缺少 Visual C++ Redistributable 執行時。

**解決方案**：
下載並安裝 Microsoft Visual C++ Redistributable：
https://aka.ms/vs/17/release/vc_redist.x64.exe

---

## Docker 相關

### Q4: Docker build 卡在 `Installing dependencies`

**症狀**：
```
Step 5/10 : RUN pip install -r requirements.txt
# 長時間無回應
```

**原因**：
- 網路慢，下載包超時
- 編譯依賴時 CPU 不足

**解決方案**：
```dockerfile
# Dockerfile 添加國內鏡像源
RUN pip install --no-cache-dir -r requirements.txt \
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或使用預編譯的基礎鏡像
FROM python:3.11-slim
RUN pip install numpy scipy scikit-learn pandas -i https://pypi.tuna.tsinghua.edu.cn/simple
COPY requirements.txt .
RUN pip install -r requirements.txt
```

---

### Q5: 容器啟動後立即退出，`docker ps` 看不到

**症狀**：
```bash
docker compose up -d
# 容器啟動後立即停止
docker ps  # 沒有執行中的容器
```

**診斷方法**：
```bash
# 查看容器日誌
docker compose logs web

# 查看退出碼
docker ps -a
```

**常見原因與解決方案**：

**原因 1：啟動命令錯誤**
```yaml
# docker-compose.yml 檢查 command
services:
  web:
    command: uvicorn main:app --host 0.0.0.0 --port 8000  # 確認路徑正確
```

**原因 2：依賴缺失**
```bash
# 進入容器調試
docker compose run --rm web bash
python -c "import fastapi; import sklearn"
```

**原因 3：端口衝突**
```bash
# 檢查端口佔用
netstat -an | findstr 8000  # Windows
lsof -i :8000               # Linux/Mac

# 修改端口
# docker-compose.yml
ports:
  - "8001:8000"  # 改用 8001
```

---

### Q6: Docker 健康檢查一直處於 `health: starting`

**症狀**：
```bash
docker ps
# HEALTH 列顯示 "health: starting" 不變
```

**原因**：
- HEALTHCHECK 命令失敗
- 健康檢查超時（預設 30s）
- 應用啟動慢

**診斷方法**：
```bash
# 手動執行健康檢查命令
docker exec <container> python -c "import requests; r=requests.get('http://localhost:8000/health'); exit(0 if r.status_code==200 else 1)"

# 查看詳細日誌
docker inspect <container> | grep -A 10 Health
```

**解決方案**：
```dockerfile
# 簡化 HEALTHCHECK（Dockerfile）
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# 或使用 Python 請求
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD python -c "import requests; r=requests.get('http://localhost:8000/health', timeout=5); exit(0 if r.ok else 1)"
```

---

### Q7: 掛載的 `data/` 或 `models/` 目錄權限錯誤

**症狀**：
```
PermissionError: [Errno 13] Permission denied: '/app/data/AAPL_short_term_with_lag3.csv'
```

**原因**：
- 容器內用戶權限與主機不一致
- Windows 掛載時路徑格式錯誤

**解決方案（Linux）**：
```bash
# 修改主機目錄權限
sudo chown -R $(id -u):$(id -g) ./data ./models

# 或在 Dockerfile 中設置用戶
# Dockerfile
RUN useradd -m -u 1000 appuser
USER appuser
```

**解決方案（Windows）**：
```powershell
# 確保掛載路徑使用正斜槓
# docker-compose.yml
volumes:
  - ./data:/app/data      # ✅ 正確
  - .\data:/app/data      # ❌ 可能失敗
```

---

## 資料建置

### Q8: `/api/build_symbol` 回傳 500，提示 "yfinance 無法取得資料"

**症狀**：
```json
{
  "ok": false,
  "error": "yfinance 無法取得 INVALID.TW"
}
```

**原因**：
1. 股票程式碼錯誤或不存在
2. Yahoo Finance API 暫時不可用
3. 網路連線問題

**解決方案**：

**步驟 1：驗證股票程式碼**
```python
import yfinance as yf

# 測試程式碼是否存在
ticker = yf.Ticker("AAPL")
hist = ticker.history(period="1d")
print(hist)  # 應回傳資料
```

**步驟 2：檢查網路連線**
```bash
curl https://query1.finance.yahoo.com/v8/finance/chart/AAPL
```

**步驟 3：使用代理（如果網路受限）**
```python
# stock.py 添加代理支持
import yfinance as yf

yf.pdr_override()
hist = yf.Ticker("AAPL", proxies={"http": "http://proxy:port"}).history()
```

---

### Q9: 臺股股票（如 2330）無法獲取資料

**症狀**：
```json
{
  "ok": false,
  "error": "yfinance 無法取得 2330"
}
```

**原因**：未添加 `.TW` 後綴。

**解決方案**：
```python
# stock.py 已自動處理，確認邏輯
def _fetch_ohlcv_yf(symbol: str, start: str = "2020-01-01"):
    if symbol.isdigit():
        ticker = f"{symbol}.TW"  # 自動添加後綴
    else:
        ticker = symbol
    
    hist = yf.Ticker(ticker).history(start=start)
    return hist
```

**手動測試**：
```python
import yfinance as yf

# ❌ 錯誤
yf.Ticker("2330").history()  # 空結果

# ✅ 正確
yf.Ticker("2330.TW").history()  # 回傳資料
```

---

### Q10: 批量建置任務卡在某個股票，進度不再更新

**症狀**：
```json
{
  "status": "running",
  "total": 100,
  "done": 45  // 長時間停留在 45
}
```

**原因**：
- 某個股票資料獲取超時
- 並發度過高導致速率限制

**解決方案**：

**步驟 1：查看錯誤日誌**
```bash
docker compose logs web | grep ERROR
```

**步驟 2：降低並發度**
```
GET /api/bulk_build_start?index=sp500&concurrency=2  # 從 4 降到 2
```

**步驟 3：添加超時控制**
```python
# stock.py 添加超時
import yfinance as yf
from requests import Session
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.util.retry import Retry

def _fetch_with_timeout(symbol, timeout=30):
    session = Session()
    retry = Retry(total=3, backoff_factor=1)
    adapter = HTTPAdapter(max_retries=retry)
    session.mount('http://', adapter)
    session.mount('https://', adapter)
    
    ticker = yf.Ticker(symbol, session=session)
    hist = ticker.history(start="2020-01-01", timeout=timeout)
    return hist
```

---

## 模型推理

### Q11: `/api/draw` 回傳 404，提示 "未發現已訓練的模型"

**症狀**：
```json
{
  "error": "未發現已訓練的模型，API 僅提供推論",
  "fortune": {
    "title": "模型未準備",
    "text": ["請在伺服器上執行訓練以產生 rf_pipeline.pkl 與 rf_threshold.pkl"]
  }
}
```

**原因**：`models/` 目錄下缺少 `*_pipeline.pkl` 或 `*_threshold.pkl` 檔案。

**解決方案**：

**步驟 1：訓練模型**
```bash
# 本地訓練
python stock.py --train --model rf

# 或同時訓練兩個模型
python stock.py --train --model all
```

**步驟 2：驗證模型檔案**
```bash
ls models/
# 應包含：
# rf_pipeline.pkl
# rf_threshold.pkl
# lr_pipeline.pkl
# lr_threshold.pkl
```

**步驟 3：如果使用 Docker，確保掛載或烤入模型**
```yaml
# docker-compose.yml (開發模式 - 掛載)
volumes:
  - ./models:/app/models

# 或 Dockerfile (生產模式 - 烤入)
COPY models/ /app/models/
```

---

### Q12: 預測結果概率始終接近 0.5，沒有區分度

**症狀**：
```json
{
  "label": "漲",
  "proba": 0.5012  // 總是接近 0.5
}
```

**原因**：
1. 模型未充分訓練（資料不足）
2. 特徵工程不當
3. 類別別高度不平衡

**解決方案**：

**步驟 1：檢查訓練資料量**
```python
import pandas as pd

df = pd.read_csv("data/AAPL_short_term_with_lag3.csv")
print(f"總行數: {len(df)}")
print(f"有效標籤數: {df['y_final'].notna().sum()}")

# 建議：至少 500+ 有效樣本
```

**步驟 2：檢查標籤分佈**
```python
print(df['y_final'].value_counts())
# 理想情況：漲跌比例在 40:60 ~ 60:40 之間
```

**步驟 3：增加訓練資料歷史長度**
```python
# stock.py 修改預設起始日期
def _fetch_ohlcv_yf(symbol: str, start: str = "2018-01-01"):  # 從 2020 改爲 2018
    pass
```

**步驟 4：重新訓練模型**
```bash
python stock.py --train --model rf
```

---

### Q13: 推理時出現 "Feature Mismatch" 錯誤

**症狀**：
```
ValueError: X has 45 features, but RandomForestClassifier expects 50 features
```

**原因**：
- 推理資料缺少訓練時使用的某些特徵
- 特徵順序不一致

**解決方案**：

**步驟 1：查看期望特徵列表**
```python
import joblib

pipeline = joblib.load("models/rf_pipeline.pkl")
print(pipeline.feature_names_in_)  # 訓練時的特徵列表
```

**步驟 2：檢查推理資料特徵**
```python
import pandas as pd

df = pd.read_csv("data/AAPL_short_term_with_lag3.csv")
print(df.columns.tolist())
```

**步驟 3：特徵對齊（自動填充缺失列）**
```python
# stock.py 已實作自動對齊
expected_features = pipeline.feature_names_in_

# 缺失的特徵填充爲 0
missing = [f for f in expected_features if f not in df.columns]
for f in missing:
    df[f] = 0.0

# 按訓練時順序選擇特徵
X_inference = df[expected_features]
```

---

## 自動更新任務

### Q14: Symbol Loop 啟動後立即停止

**症狀**：
```bash
# 調用啟動介面
GET /api/auto/start_symbol?symbol=AAPL&interval=5

# 檢查狀態
docker compose logs web | grep "symbol auto"
# 日誌顯示任務立即停止
```

**原因**：
1. 協程建立失敗
2. 首次資料建置例外退出
3. 任務被其他操作取消

**診斷方法**：
```bash
# 查看完整日誌
docker compose logs -f web

# 查看非同步任務狀態
curl http://localhost:8000/api/auto/list_registry
```

**解決方案**：

**步驟 1：手動測試資料建置**
```bash
curl "http://localhost:8000/api/build_symbol?symbol=AAPL"
# 確認能成功建置
```

**步驟 2：檢查 registry 檔案**
```bash
cat data/auto_registry.json
# 應包含類別似內容：
# {"AAPL": {"interval": 5, "backoff_factor": 2.0, "max_backoff": 30}}
```

**步驟 3：重啓服務以復原任務**
```bash
docker compose restart web
```

---

### Q15: 指數自動更新頻繁失敗，backoff 時間越來越長

**症狀**：
```
[index auto] 更新 sp500 失敗 (#3): HTTPError 429 Too Many Requests
[index auto] sp500 本輪有失敗，使用 backoff 休息 30 分鐘 (連續失敗 3)
```

**原因**：Yahoo Finance API 速率限制（短時間內請求過多）。

**解決方案**：

**步驟 1：降低並發度**
```
GET /api/auto/stop_index?index=sp500
GET /api/auto/start_index?index=sp500&interval=10&concurrency=2  # 從 4 降到 2
```

**步驟 2：增加更新間隔**
```
GET /api/auto/start_index?index=sp500&interval=15&concurrency=4  # 從 5 分鐘改爲 15 分鐘
```

**步驟 3：調整 backoff 參數**
```
GET /api/auto/start_index?index=sp500&interval=5&concurrency=4&backoff_factor=3&max_backoff=60
# 退避因子改爲 3（更激進），最大退避時間 60 分鐘
```

---

## 監控與日誌

### Q16: `/metrics` 端點回傳 404

**症狀**：
```bash
curl http://localhost:8000/metrics
# 404 Not Found
```

**原因**：
1. `prometheus-client` 未安裝
2. 路由未正確註冊

**解決方案**：

**步驟 1：確認依賴已安裝**
```bash
pip show prometheus-client
# 應顯示版本信息
```

**步驟 2：檢查 main.py 是否包含 `/metrics` 路由**
```python
from prometheus_client import generate_latest, CONTENT_TYPE_LATEST

@app.get('/metrics')
def metrics():
    data = generate_latest()
    return Response(content=data, media_type=CONTENT_TYPE_LATEST)
```

**步驟 3：重啓服務**
```bash
docker compose restart web
```

---

### Q17: 日誌中看不到請求詳情（如 IP、請求 ID）

**症狀**：
```
INFO: 127.0.0.1 - "GET /api/draw HTTP/1.1" 200 OK
# 缺少詳細的請求信息
```

**原因**：未啓用結構化日誌中間件。

**解決方案**：

確認 `main.py` 中間件已配置：
```python
@app.middleware("http")
async def metrics_and_logging_middleware(request: Request, call_next):
    req_id = request.headers.get("x-request-id") or str(uuid.uuid4())
    start = time.perf_counter()
    
    response = await call_next(request)
    
    duration = time.perf_counter() - start
    logger.info(
        f"req_id={req_id} method={request.method} path={request.url.path} "
        f"status={response.status_code} ms={duration*1000:.2f} "
        f"ip={request.client.host}"
    )
    return response
```

---

## 效能問題

### Q18: 推理延遲高（> 1 秒）

**症狀**：
```bash
curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:8000/api/draw?model=rf"
# time_total: 1.523s
```

**原因**：
1. 模型檔案每次重新載入
2. CSV 檔案過大
3. 特徵計算耗時

**解決方案**：

**步驟 1：添加模型快取**
```python
# stock.py
_MODEL_CACHE = {}

def predict(csv_path, model):
    cache_key = f"{model}_pipeline"
    if cache_key not in _MODEL_CACHE:
        _MODEL_CACHE[cache_key] = joblib.load(f"models/{model}_pipeline.pkl")
    
    pipeline = _MODEL_CACHE[cache_key]
    # ...
```

**步驟 2：最佳化 CSV 讀取（僅讀取必要列）**
```python
# 只讀取推理所需的列
usecols = expected_features + ['年月日']
df = pd.read_csv(csv_path, usecols=usecols)
```

**步驟 3：使用 Parquet 替代 CSV（可選）**
```python
# 儲存爲 Parquet（更快）
df.to_parquet("data/AAPL.parquet")

# 讀取 Parquet
df = pd.read_parquet("data/AAPL.parquet")
```

---

### Q19: 記憶體佔用持續增長（記憶體洩漏）

**症狀**：
```bash
docker stats
# CONTAINER   MEM USAGE
# web         250MB -> 500MB -> 1GB  (持續增長)
```

**原因**：
1. 未釋放的 DataFrame 或模型物件
2. 後臺任務積累
3. 日誌物件未清理

**診斷方法**：
```bash
# 安裝 memory_profiler
pip install memory_profiler

# 在 main.py 添加記憶體監控
from memory_profiler import profile

@profile
def predict_with_profiling():
    # ...
```

**解決方案**：

**步驟 1：顯式釋放大物件**
```python
def predict(csv_path, model):
    df = pd.read_csv(csv_path)
    # ... 處理
    result = compute_result()
    
    # 釋放 DataFrame
    del df
    import gc
    gc.collect()
    
    return result
```

**步驟 2：限制後臺任務數量**
```python
# 最多保留最近 100 個已完成任務
if len(BULK_TASKS) > 100:
    old_tasks = sorted(BULK_TASKS.items(), key=lambda x: x[1].get('finished_at', 0))
    for task_id, _ in old_tasks[:50]:
        BULK_TASKS.pop(task_id, None)
```

---

## 部署問題

### Q20: Caddy 無法自動獲取 HTTPS 證書

**症狀**：
```bash
docker compose -f docker-compose.prod.yml logs caddy
# obtaining certificate: acme: error: 403
```

**原因**：
1. DNS 記錄未正確配置
2. 端口 80/443 未對外開放
3. 域名未驗證所有權

**解決方案**：

**步驟 1：驗證 DNS 記錄**
```bash
nslookup app.example.com
# 應回傳服務器的公網 IP
```

**步驟 2：檢查端口開放**
```bash
# 確保防火牆允許 80/443
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 檢查端口監聽
netstat -tuln | grep -E ':(80|443)'
```

**步驟 3：驗證 Caddyfile 配置**
```
{$DOMAIN} {
    reverse_proxy web:8000
}
```

**步驟 4：使用臨時證書測試（自籤）**
```
{$DOMAIN} {
    tls internal  # 使用自簽證書（僅測試用）
    reverse_proxy web:8000
}
```

---

## 相關文檔

- [01_架構概覽.md](./01_架構概覽.md) - 系統架構與技術棧
- [02_資料模型.md](./02_資料模型.md) - 核心資料結構
- [03_業務規則.md](./03_業務規則.md) - 業務邏輯與特殊規則
- [04_術語詞彙.md](./04_術語詞彙.md) - 統一術語與命名約定
- [05_開發規範.md](./05_開發規範.md) - 程式碼風格與開發流程
