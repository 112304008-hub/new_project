# 04 術語詞彙

## 業務術語

### 股票市場相關

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| 股票程式碼 | Symbol | 股票、ETF 或指數的唯一標識符 | AAPL, 2330, MSFT |
| 代號 | Ticker | Yahoo Finance 格式的股票程式碼 | AAPL, 2330.TW, TSM |
| 開盤價 | Open Price | 當日第一筆交易價格 | 100.50 元 |
| 收盤價 | Close Price | 當日最後一筆交易價格 | 103.00 元 |
| 最高價 | High Price | 當日最高交易價格 | 105.20 元 |
| 最低價 | Low Price | 當日最低交易價格 | 99.80 元 |
| 成交量 | Volume | 當日交易的股票數量 | 12,500,000 股 |
| 漲跌幅 | Return | 相對前一日收盤價的變化百分比 | +2.48% |
| 跳空 | Gap | 開盤價與前日收盤價的差距 | +1.52% |
| 振幅 | Range | 當日最高價與最低價的差距 | 5.40% |
| 移動平均線 | Moving Average (MA) | 過去 N 天收盤價的平均值 | MA5, MA20 |
| ADR | American Depositary Receipt | 美國存託憑證（臺積電 ADR: TSM） | TSM |

### 機器學習相關

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| 特徵 | Feature | 輸入變數，用於模型預測 | 收盤價_lag1, MA5差％ |
| 標籤 | Label | 目標變數，模型要預測的輸出 | y_final (0/1) |
| 訓練集 | Training Set | 用於訓練模型的資料 | 前 80% 資料 |
| 驗證集 | Validation Set | 用於調參和選擇模型的資料 | 中間 16% 資料 |
| 測試集 | Test Set | 用於評估模型效能的資料 | 後 20% 資料 |
| 推理 | Inference | 使用訓練好的模型進行預測 | predict(X_test) |
| 管道 | Pipeline | 組合多個預處理和模型步驟 | Scaler + RandomForest |
| 閾值 | Threshold | 將概率轉換爲類別別的分界點 | 0.55 |
| 特徵工程 | Feature Engineering | 從原始資料建立新特徵的過程 | 計算 MA, lag 特徵 |
| 過擬合 | Overfitting | 模型在訓練集上表現好，泛化差 | 驗證集準確率低 |
| 類別別不平衡 | Class Imbalance | 正負樣本數量差異大 | 漲:跌 = 6:4 |

### 統計與指標

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| 準確率 | Accuracy | 正確預測的樣本佔比 | 0.65 (65%) |
| 精確率 | Precision | 預測爲正類別中真正爲正類別的比例 | 0.70 |
| 召回率 | Recall | 真正爲正類別中被預測爲正類別的比例 | 0.60 |
| F1 分數 | F1 Score | 精確率和召回率的調和平均 | 0.65 |
| AUC | Area Under Curve | ROC 曲線下面積（模型區分能力） | 0.72 |
| 中位數 | Median | 資料排序後的中間值 | [1,2,3,4,5] → 3 |
| 標準差 | Standard Deviation | 資料離散程度的度量 | σ = 2.5 |
| 分位數 | Quantile | 將資料分成數個等份的分界點 | Q1=0.25, Q3=0.75 |
| Winsorization | - | 將極端值截斷到指定分位數 | 1%-99% 分位 |

---

## 技術術語

### 系統架構

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| 端點 | Endpoint | API 的訪問路徑 | /api/draw |
| 路由 | Route | URL 到處理函式的映射 | @app.get("/health") |
| 中間件 | Middleware | 請求處理前後的攔截層 | logging, rate limit |
| 非同步 | Async | 非阻塞式執行的編程模式 | async def, await |
| 協程 | Coroutine | Python 非同步編程的基本單元 | asyncio.Task |
| 容器 | Container | 應用和依賴的隔離執行環境 | Docker 容器 |
| 鏡像 | Image | 容器的只讀模板 | new_project:latest |
| 掛載 | Mount | 將主機目錄映射到容器內部 | -v ./data:/app/data |
| 反向代理 | Reverse Proxy | 位於服務器前的代理服務器 | Caddy, Nginx |

### 後臺任務

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| Symbol Loop | - | 單股票週期性自動更新任務 | 每 5 分鐘更新 AAPL |
| Index Loop | - | 指數成分批量更新任務 | 每 5 分鐘更新 S&P 500 |
| Bulk Task | - | 一次性批量建置任務 | 建置 500 檔股票 |
| 任務 ID | Task ID | 批量任務的唯一標識符 | uuid-string |
| 任務狀態 | Task Status | 任務當前執行狀態 | running, completed |
| 並發度 | Concurrency | 同時執行的任務數量 | 4 |
| 退避 | Backoff | 失敗後延長重試間隔的策略 | 指數退避 |
| 退避因子 | Backoff Factor | 退避時間的倍增係數 | 2.0 |
| 最大退避 | Max Backoff | 退避時間的上限 | 30 分鐘 |
| Registry | - | 持久化的任務配置檔案 | auto_registry.json |

### 監控與日誌

| 術語 | 英文 | 定義 | 範例 |
|------|------|------|------|
| 健康檢查 | Health Check | 判斷服務是否正常執行 | /health |
| 指標 | Metrics | 用於監控的量化資料 | HTTP 請求數, 延遲 |
| 計數器 | Counter | 單調遞增的指標類型 | http_requests_total |
| 直方圖 | Histogram | 可觀測值分佈的指標類型 | request_duration |
| 儀表盤 | Gauge | 可增可減的即時值指標 | background_tasks |
| 日誌級別 | Log Level | 日誌的重要性分類別 | DEBUG, INFO, ERROR |
| 請求 ID | Request ID | 追蹤單個請求的唯一標識 | x-request-id |
| 速率限制 | Rate Limit | 限制請求頻率的機制 | 120 req/min |

---

## 編碼規範

### 命名約定

#### 1. 變數與函式命名

**Python 風格（snake_case）**：
```python
# 變數
symbol_csv_path = Path("data/AAPL_short_term_with_lag3.csv")
consecutive_failures = 0
backoff_factor = 2.0

# 函式
def build_from_yfinance(symbol: str, out_csv: Path):
    pass

def normalize_tw_ticker(symbol: str) -> str:
    pass
```

**私有函式前綴（_）**：
```python
def _ensure_yf():           # 內部輔助函式
    pass

def _build_y(df, thresh):   # 內部資料處理函式
    pass
```

**非同步函式（async def）**：
```python
async def _symbol_loop(symbol, interval_min):
    pass

async def _bulk_build_worker(symbols, concurrency, task_id):
    pass
```

#### 2. 類別命名（PascalCase）

```python
class StandardScaler:
    pass

class RandomForestClassifier:
    pass

class LogisticRegression:
    pass
```

#### 3. 常量命名（UPPER_CASE）

```python
THRESH = 0.01
VAL_SPLIT = 0.2
TEST_SPLIT = 0.2
DEFAULT_CSV = Path("data/short_term_with_lag3.csv")
MODELS_DIR = Path("models")
API_KEY = os.getenv("API_KEY")
```

#### 4. API 端點命名

**RESTful 風格**：
```
GET  /api/draw              # 獲取預測結果
GET  /api/build_symbol      # 建置單個股票
GET  /api/build_symbols     # 建置多個股票
GET  /api/bulk_build_start  # 啟動批量任務
GET  /api/bulk_build_status # 查詢任務狀態
GET  /api/auto/start_symbol # 啟動自動更新
GET  /api/auto/stop_symbol  # 停止自動更新
```

**命名規則**：
- 使用動詞 + 名詞（`build_symbol`）
- 層級關係使用 `/`（`/api/auto/start_symbol`）
- 查詢參數使用 snake_case（`?symbol=AAPL&interval=5`）

#### 5. 檔案命名

**Python 模塊（snake_case）**：
```
main.py
stock.py
test.py
```

**資料檔案（symbol + 描述）**：
```
AAPL_short_term_with_lag3.csv
2330_short_term_with_lag3.csv
AAPL_last_update.txt
```

**配置檔案（snake_case.json）**：
```
auto_registry.json
index_auto_registry.json
feature_names.json
```

**模型檔案（model_type + 描述.pkl）**：
```
rf_pipeline.pkl
rf_threshold.pkl
lr_pipeline.pkl
lr_threshold.pkl
```

#### 6. 環境變數（UPPER_CASE）

```bash
API_KEY=your-secret-key
RATE_LIMIT_PER_MIN=120
LOG_LEVEL=INFO
APP_GIT_SHA=abc123
APP_BUILD_TIME=2024-01-15T08:30:00Z
DATA_DIR_WRITE=/data/writable
```

---

## 程式碼註釋規範

### 1. 模塊級註釋（Docstring）

```python
"""
stock.py - 股票資料處理與模型預測模塊

提供功能：
- 資料獲取（Yahoo Finance API 封裝）
- 特徵工程（技術指標計算、滯後特徵生成）
- 模型訓練（隨機森林、邏輯迴歸）
- 預測推理（模型載入、特徵對齊、推理執行）

用法範例：
    from stock import predict, predict_latest
    result = predict_latest(model="rf")
"""
```

### 2. 函式級註釋（Docstring）

```python
def predict(csv_path: Optional[Union[str, Path]] = None,
            model: Literal["rf", "lr"] = "rf",
            symbol: Optional[str] = None) -> Dict[str, Any]:
    """
    讀取 CSV 資料並執行模型推理，回傳預測結果。

    Args:
        csv_path: CSV 檔案路徑（預設使用 data/short_term_with_lag3.csv）
        model: 模型類型（"rf" 或 "lr"）
        symbol: 股票程式碼（可選，用於尋找對應 CSV）

    Returns:
        Dict: 包含以下鍵的字典
            - label: "漲" 或 "跌"
            - proba: 上漲概率 (0-1)
            - threshold: 分類別閾值
            - model: 使用的模型類型
            - csv: 實際使用的 CSV 路徑
            - symbol: 股票程式碼

    Raises:
        FileNotFoundError: CSV 檔案不存在
        RuntimeError: 模型檔案缺失或推理失敗

    Example:
        >>> result = predict(model="rf", symbol="AAPL")
        >>> print(result["label"])  # "漲"
        >>> print(result["proba"])  # 0.6523
    """
```

### 3. 行內註釋

**解釋複雜邏輯**：
```python
# 指數退避：sleep = min(max_backoff, interval * backoff_factor ** failures)
sleep_time = min(
    max_backoff_min,
    interval_min * (backoff_factor ** consecutive_failures)
)
```

**標註重要步驟**：
```python
# 1. 載入預訓練模型
pipeline = joblib.load(model_path)

# 2. 特徵對齊（確保與訓練時一致）
X_inference = X_all[expected_features]

# 3. 模型推理
proba = pipeline.predict_proba(X_inference)[:, 1][0]
```

**警告或注意事項**：
```python
# WARNING: 不要在生產環境中執行重量級訓練
if os.getenv("ENV") == "production":
    raise RuntimeError("禁止在生產環境訓練模型")

# NOTE: 臺股程式碼需要添加 .TW 後綴
if symbol.isdigit():
    ticker = f"{symbol}.TW"
```

### 4. TODO 註釋

```python
# TODO: 支持多模型整合（ensemble）
# TODO: 添加模型版本管理（MLflow）
# TODO: 實作分佈式訓練（Dask）
# FIXME: 修復當 CSV 爲空時的例外處理
# HACK: 臨時解決方案，等待上遊端 yfinance 修復
```

---

## 狀態碼與錯誤信息

### HTTP 狀態碼使用規範

| 狀態碼 | 含義 | 使用場景 | 範例 |
|--------|------|----------|------|
| 200 | 成功 | 請求成功處理 | 預測成功回傳結果 |
| 400 | 請求錯誤 | 參數缺失或格式錯誤 | symbol 爲空 |
| 401 | 未授權 | API Key 錯誤或缺失 | x-api-key 不匹配 |
| 404 | 未找到 | 資源不存在 | CSV 檔案或模型缺失 |
| 429 | 速率限制 | 請求頻率過高 | 超過 120 req/min |
| 500 | 服務器錯誤 | 內部例外 | 模型推理失敗 |

### 錯誤回應格式

```json
{
  "error": "找不到有效的 short_term_with_lag3.csv，請先執行 test.py 建立資料",
  "fortune": {
    "title": "找不到資料",
    "text": ["請先執行 test.py 建立最新特徵資料。"],
    "advice": "請確認 test.py 有啟動成功併產生 CSV。"
  }
}
```

### 常見錯誤信息模板

| 場景 | 錯誤信息 | 建議 |
|------|----------|------|
| CSV 不存在 | "找不到有效的 CSV，請先執行建置" | "請調用 /api/build_symbol" |
| 模型缺失 | "未發現已訓練的模型，API 僅提供推論" | "請先在主機上訓練並將模型儲存在 models/" |
| 參數缺失 | "請提供 symbol 參數" | "範例：?symbol=AAPL" |
| 網路超時 | "無法連線到 Yahoo Finance" | "請檢查網路連線或稍後再試" |
| 資料品質差 | "CSV 沒有資料或格式無效" | "請重新建置該股票資料" |

---

## 日誌格式規範

### 結構化日誌（key=value）

```
ts=2024-01-15T08:30:00.123 level=INFO msg=request started module=main
ts=2024-01-15T08:30:00.456 level=INFO msg=prediction successful module=stock
ts=2024-01-15T08:30:00.789 level=ERROR msg=model file not found module=main
```

### 日誌級別使用規範

| 級別 | 使用場景 | 範例 |
|------|----------|------|
| DEBUG | 詳細調試信息 | "載入特徵列表：['收盤價_lag1', ...]" |
| INFO | 正常業務日誌 | "預測成功：AAPL, proba=0.65" |
| WARNING | 警告但不影響執行 | "CSV 資料過舊（7 天前）" |
| ERROR | 錯誤但可復原 | "Yahoo Finance 超時，重試中" |
| CRITICAL | 嚴重錯誤需立即處理 | "模型檔案損壞，服務不可用" |

---

## 相關文檔

- [01_架構概覽.md](./01_架構概覽.md) - 系統架構與技術棧
- [02_資料模型.md](./02_資料模型.md) - 核心資料結構
- [03_業務規則.md](./03_業務規則.md) - 業務邏輯與特殊規則
- [05_開發規範.md](./05_開發規範.md) - 程式碼風格與開發流程
