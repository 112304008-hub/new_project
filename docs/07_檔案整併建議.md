# 07 檔案整併建議（根目錄檔案）— 已執行調整摘要

本文件根據《01_架構概覽》與目前專案實際使用情況，整理根目錄之零散檔案，並完成第一波「整併與清理」。以下為調整結果與後續注意事項。

---

## 一、建議保留（核心/直接被使用）
- main.py：FastAPI 應用入口，核心 Web 服務。
- stock.py：資料處理與模型推論邏輯，核心業務模組。
- template2.html：首頁互動頁面（籤筒 Demo），由 `main.py` 直接回傳。
- requirements.txt：依賴清單，Docker 與本機環境皆使用。
- Dockerfile：生產映像建置必需。
- docker-compose.yml：開發模式（掛載專案、data、models）。
- docker-compose.prod.yml：生產模式（Caddy 反向代理、自動 HTTPS）。
- docker-compose.override.yml：本機測試額外端口/本機 Caddy 設定覆蓋。
- docker-compose.https.local.yml：本機 HTTPS 測試（與 override 並列，兩者用途不同，建議保留）。
- infra/（特別是 infra/caddy/conf/Caddyfile）：正式 Caddy 設定檔位置，生產與本機 HTTPS 由此讀取。
- scripts/Run-DDNS.ps1、scripts/ddns/ddns_updater.py：對應 docker-compose.prod.yml 的 ddns 服務，建議保留。
- scripts/Setup-Env.ps1：Windows 快速建立/更新虛擬環境腳本，建議保留。
- README.md、docs/**：專案與技術文檔，建議保留。
- .env.example、.env（本機）：環境變數樣板/本機設定，建議保留（.env 已在 .gitignore）。
- .dockerignore、.gitignore、pytest.ini：通用設定，建議保留。

---

## 二、已整併（移動到 scripts/ 子資料夾）
這些屬於開發/測試/一次性任務腳本，已集中到 `scripts/` 並依用途分群，讓根目錄更乾淨。

- 類別 A：批次/清單工具（可歸檔到 `scripts/batch/`）
  - 已移動：
    - scripts/batch/fetch_sp500_github.py
    - scripts/batch/fetch_tech_and_start.py
    - scripts/batch/start_first50.py
    - scripts/batch/start_next50.py
    - scripts/batch/start_and_monitor_batch3.py
    - scripts/batch/start_and_monitor_batch4.py
  - 後續優化：可整併為一支帶參數腳本（例如 `build_sp500_batch.py --offset 0 --limit 50`），減少重複。

- 類別 B：開發/調試小工具（可歸檔到 `scripts/dev/`）
  - 已移動：
    - scripts/dev/run_api_smoke.py
    - scripts/dev/run_bulk_build.py
    - scripts/dev/run_bulk_task_test.py
    - scripts/dev/run_predict.py（新增 CLI：支援 `--symbol/--model`，取代 `predict_msft.py`、`try_msft.py`）
    - scripts/dev/run_test_bulk.py
    - scripts/dev/monitor_task2.py（統一保留此版）
  - 根目錄相同檔名已改為「轉發器」（forwarder），相容舊路徑但會提示改用 `python -m scripts...`。

- 類別 C：文件/工具（可歸檔到 `scripts/tools/` 或 `scripts/docs/`）
  - 已移動：
    - scripts/tools/check_twelve.py
    - scripts/docs/convert_to_traditional.py（README 範例已更新）

- 類別 D：建置便利腳本
  - 已移動：`scripts/Build-And-Run-Prod.ps1`
  - 根目錄 `build_and_run_prod.ps1` 已改為 thin wrapper 轉呼叫 `scripts/Build-And-Run-Prod.ps1`

移動後注意：
- 已在 `scripts/` 各子資料夾補上 `__init__.py`，可用 `python -m` 方式執行。
- README 已同步更新：
  - 提供 `python -m scripts.*` 使用方式
  - `convert_to_traditional` 範例改為 `python -m scripts.docs.convert_to_traditional`

---

## 三、已清理（冗餘/過時/暫存）
- 根目錄 Caddyfile：已改為 stub，註明改用 `infra/caddy/conf/Caddyfile`。
- staged_list.txt：已清空並加上 deprecation 註記，待後續完全移除。
- monitor_task.py：已改為轉發器導向 `scripts.dev.monitor_task2`。
- predict_msft.py、try_msft.py：已改為轉發器導向統一版 `scripts.dev.run_predict`。

---

## 四、關鍵舉例與理由對照
- 為何保留根本體（main.py/stock.py/template2.html/static/）？
  - 直接受 FastAPI 服務與前端頁面使用，屬核心執行檔案。
- 為何處理根目錄 Caddyfile？
  - docker-compose.prod.yml 與本地 HTTPS 均指向 `infra/caddy/conf/Caddyfile` 或 `Caddyfile.local`。保留單一位置可避免改 A 忘了改 B，因此根目錄版本改為 stub 與說明。
- 為何合併多個「批次 50 檔」腳本？
  - 目前以不同檔案硬編索引區間（前 50/後 50/第 101-150…），改成帶參數腳本即可涵蓋多種批次，維護成本更低。
- test.py 要如何處理？
  - 仍暫時保留。未來可將 `perform_update`/`/api/quick` 能力抽為 `scripts/tools/build_data.py`，並調整 `main.py` 的提示訊息。

---

## 五、執行方案（實際進度）
✔ 已完成：
1) 新增 `scripts/dev/`、`scripts/batch/`、`scripts/tools/`、`scripts/docs/` 與 `__init__.py`
2) 批次移動腳本至對應資料夾；重疊者整併（`run_predict.py` 提供統一 CLI）
3) README 更新（`python -m` 執行方式、文檔轉繁腳本新路徑）
4) 根目錄相同檔名改為轉發器（保留相容性），Caddyfile 改為 stub

⏳ 待辦：
- 統一批次腳本為參數化版本（offset/limit）
- 視情況完全移除已標示為轉發器/暫存的檔案（保留於 Git 歷史即可）
- 小型 smoke test 清單自動化（可加入 Makefile/Tasks）

---

## 六、移動後可能的影響與對策
- 匯入路徑：請從專案根目錄執行（或使用 `python -m`）；避免在 `scripts/` 內直接 `python foo.py` 導致 `import main` 找不到。
- README/文檔中的路徑：已同步更新（尤其 `convert_to_traditional.py` 範例）。
- CI/CD 或任何自動化腳本：若有引用檔名/路徑，請同步調整。

---

## 七、如何執行（常用指令）
從專案根目錄以模組方式執行：

```powershell
# 單股預測（以 AAPL 為例）
python -m scripts.dev.run_predict --symbol AAPL --model rf

# API 冒煙測試
python -m scripts.dev.run_api_smoke

# 啟動 S&P 500 批次建置（第一批）
python -m scripts.batch.start_first50

# Docs 簡轉繁
python -m scripts.docs.convert_to_traditional
```

若要回退舊路徑，根目錄同名腳本仍可執行，但會提示改用上述模組方式。