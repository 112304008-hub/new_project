# 02 資料模型

## 核心實體

### 1. Symbol (股票程式碼實體)

**定義**：股票、ETF 或指數的唯一標識符。

**屬性**：
```python
symbol: str          # 股票程式碼 (如 "AAPL", "2330", "MSFT")
ticker: str          # Yahoo Finance 格式程式碼 (如 "AAPL", "2330.TW")
market: str          # 市場標識 ("US", "TW", "HK")
```

**規範化規則**：
- 臺股：純數字程式碼（如 "2330"）→ 自動添加 ".TW" 後綴用於 API 查詢
- 美股：字母程式碼（如 "AAPL"）→ 直接使用
- 特殊符號：替換 "." 爲 "-"（如 "BRK.B" → "BRK-B"）

**範例**：
```python
# 臺灣積體電路製造公司
{
    "symbol": "2330",
    "ticker": "2330.TW",
    "market": "TW"
}

# 蘋果公司
{
    "symbol": "AAPL",
    "ticker": "AAPL",
    "market": "US"
}
```

---

### 2. OHLCV (行情資料實體)

**定義**：開盤價、最高價、最低價、收盤價、成交量的時間序列資料。

**欄位定義**：

| 欄位名 | 類型 | 單位 | 說明 | 範例 |
|--------|------|------|------|------|
| 年月日 | datetime | - | 交易日期 (YYYY-MM-DD) | "2024-01-15" |
| 開盤價(元) | float | 本地貨幣 | 當日開盤價 | 100.5 |
| 最高價(元) | float | 本地貨幣 | 當日最高價 | 105.2 |
| 最低價(元) | float | 本地貨幣 | 當日最低價 | 99.8 |
| 收盤價(元) | float | 本地貨幣 | 當日收盤價 | 103.0 |
| 成交量(千股) | float | 千股 | 當日成交量 | 12500.0 |

**資料源**：Yahoo Finance API (`yfinance` 庫)

**獲取範例**：
```python
import yfinance as yf

# 獲取臺股資料
data = yf.Ticker("2330.TW").history(start="2020-01-01", interval="1d")

# 獲取美股資料
data = yf.Ticker("AAPL").history(start="2020-01-01", interval="1d")
```

**資料清洗規則**：
1. 移除缺失日期（非交易日）
2. 成交量從原始股數轉換爲千股（`/= 1000`）
3. 價格保留小數點後 2 位
4. 成交量保留小數點後 1 位

---

### 3. Feature (特徵資料實體)

**定義**：由原始 OHLCV 資料計算得出的技術指標和衍生特徵。

#### 3.1 基礎特徵

| 欄位名 | 類型 | 單位 | 公式 | 說明 |
|--------|------|------|------|------|
| 報酬率％ | float | % | (close_t / close_{t-1} - 1) * 100 | 日收益率 |
| Gap％ | float | % | (open_t / close_{t-1} - 1) * 100 | 跳空幅度 |
| 振幅％ | float | % | (high_t - low_t) / close_{t-1} * 100 | 日內波動幅度 |

#### 3.2 移動平均線特徵

| 欄位名 | 類型 | 單位 | 公式 | 說明 |
|--------|------|------|------|------|
| MA5 | float | 本地貨幣 | mean(close[-5:]) | 5 日均線 |
| MA10 | float | 本地貨幣 | mean(close[-10:]) | 10 日均線 |
| MA20 | float | 本地貨幣 | mean(close[-20:]) | 20 日均線 |
| MA5差％ | float | % | (close / MA5 - 1) * 100 | 收盤價偏離 MA5 |
| MA20差％ | float | % | (close / MA20 - 1) * 100 | 收盤價偏離 MA20 |

#### 3.3 成交量特徵

| 欄位名 | 類型 | 單位 | 公式 | 說明 |
|--------|------|------|------|------|
| 成交量(千股)_log | float | - | log(1 + volume) | 對數成交量 |
| 成交量(千股)_rel20％ | float | % | (volume / median(volume[-20:]) - 1) * 100 | 相對 20 日中位數 |

#### 3.4 時間特徵

| 欄位名 | 類型 | 取值範圍 | 說明 |
|--------|------|----------|------|
| 週幾 | int | 0-4 | 星期幾 (0=週一, 4=週五) |

#### 3.5 滯後特徵 (Lag Features)

**定義**：將當前及歷史時間點的特徵值作爲當前行的輸入特徵。

**滯後窗口**：1-5 天

**應用特徵列表**：
- 收盤價(元)
- 成交量(千股)
- 報酬率％
- Gap％
- 振幅％
- MA5差％
- MA20差％
- 成交量(千股)_log
- 成交量(千股)_rel20％

**命名規則**：`{特徵名}_lag{N}`

**範例**：
```
收盤價(元)_lag1  → 前 1 天的收盤價
收盤價(元)_lag2  → 前 2 天的收盤價
收盤價(元)_lag3  → 前 3 天的收盤價
報酬率％_lag1    → 前 1 天的報酬率
MA5差％_lag1     → 前 1 天的 MA5 偏離度
```

**生成邏輯**：
```python
lag_cols = ['收盤價(元)', '成交量(千股)', '報酬率％', 'Gap％', '振幅％', 
            'MA5差％', 'MA20差％', '成交量(千股)_log', '成交量(千股)_rel20％']

for col in lag_cols:
    for lag in range(1, 6):  # lag 1 to 5
        df[f"{col}_lag{lag}"] = df[col].shift(lag)
```

#### 3.6 外部特徵（臺股專用）

| 欄位名 | 類型 | 說明 | 資料源 |
|--------|------|------|--------|
| USDTWD | float | 美元兌新臺幣匯率 | Yahoo Finance (TWD=X) |
| TSM_ADR_close | float | 臺積電 ADR 收盤價 (美元) | Yahoo Finance (TSM) |
| TSM_ADR_ret1d | float | 臺積電 ADR 日收益率 | 計算得出 |
| TSM_ADR_gap％ | float | ADR 調整後的 Gap (考慮匯率) | 計算得出 |

**TSM_ADR_gap％ 計算公式**：
```python
TSM_ADR_gap％ = ((1 + TSM_ADR_ret1d) * (1 + USDTWD_ret1d) - 1) * 100
```

---

### 4. Label (標籤實體)

**定義**：用於模型訓練和推理的目標變數。

#### 4.1 二分類別標籤

| 欄位名 | 類型 | 取值 | 說明 |
|--------|------|------|------|
| y_明天漲跌 | int | 0 / 1 | 明天漲跌標籤 (簡單版) |
| y_final | int | 0 / 1 | 最終標籤 (帶閾值篩選) |

#### 4.2 標籤生成規則

**簡單版（無閾值）**：
```python
明天收盤價 = 收盤價(元).shift(-1)
y_明天漲跌 = (明天收盤價 > 收盤價(元)).astype(int)
```

**閾值篩選版（推薦用於訓練）**：
```python
THRESH = 0.01  # 1% 閾值

ret1 = (明天收盤價 - 收盤價(元)) / 收盤價(元)

if ret1 > THRESH:      # 漲幅超過 1%
    y_final = 1
elif ret1 < -THRESH:   # 跌幅超過 1%
    y_final = 0
else:                  # 漲跌幅在 [-1%, 1%] 之間
    y_final = NaN      # 篩選掉噪聲樣本
```

**設計理由**：
- 篩選小幅波動的噪聲樣本
- 聚焦於明確的漲跌信號
- 提高模型預測的有效性

---

### 5. Model (模型實體)

**定義**：訓練完成的機器學習模型及其元資料。

#### 5.1 模型檔案結構

```
models/
├── rf_pipeline.pkl           # 隨機森林模型管道
├── rf_threshold.pkl          # 隨機森林分類別閾值
├── lr_pipeline.pkl           # 邏輯迴歸模型管道
├── lr_threshold.pkl          # 邏輯迴歸分類別閾值
└── feature_names.json        # 訓練時使用的特徵列表
```

#### 5.2 Pipeline 結構

```python
Pipeline([
    ('scaler', StandardScaler()),        # 特徵標準化
    ('mdl', RandomForestClassifier())    # 分類別器
])
```

**包含組件**：
1. **StandardScaler**：
   - 作用：特徵標準化（均值 0，方差 1）
   - 儲存狀態：訓練集的均值和標準差
   
2. **分類別器**：
   - RandomForestClassifier：隨機森林
   - LogisticRegression：邏輯迴歸

#### 5.3 Threshold (分類別閾值)

**定義**：將模型輸出的概率 `P(y=1)` 轉換爲二分類別標籤的閾值。

**預設閾值**：0.5

**最佳化閾值**：基於驗證集 F1-score 網格搜尋得出（範圍 0.30-0.70）

**使用方式**：
```python
proba = model.predict_proba(X_test)[:, 1]  # 上漲概率
threshold = 0.55                             # 最佳化後的閾值
y_pred = (proba >= threshold).astype(int)   # 預測標籤
```

#### 5.4 Feature Names

**定義**：模型訓練時使用的特徵列表（順序固定）。

**用途**：
- 推理時特徵對齊（防止 Feature Mismatch）
- 確保新資料特徵順序與訓練一致

**範例**：
```json
[
  "收盤價(元)_lag1",
  "收盤價(元)_lag2",
  "成交量(千股)_lag1",
  "報酬率％_lag1",
  "MA5差％_lag1",
  ...
]
```

---

### 6. Task (任務實體)

**定義**：後臺任務的元資料和狀態。

#### 6.1 Bulk Task (批量建置任務)

```python
{
    "task_id": "uuid-string",        # 任務唯一標識
    "status": "running",             # 任務狀態
    "total": 100,                    # 總數量
    "done": 45,                      # 已完成數量
    "errors": {                      # 錯誤記錄
        "AAPL": "Network timeout",
        "MSFT": "Invalid ticker"
    },
    "started_at": 1704067200.0,      # 開始時間戳
    "finished_at": 1704070800.0      # 完成時間戳
}
```

**狀態枚舉**：
- `"running"` - 執行中
- `"completed"` - 已完成
- `"cancelled"` - 已取消

#### 6.2 Symbol Task (單股票自動更新任務)

```python
SYMBOL_TASKS = {
    "AAPL": asyncio.Task(...),       # asyncio 協程任務物件
    "2330": asyncio.Task(...),
    ...
}
```

**任務參數**（存儲在 `auto_registry.json`）：
```json
{
  "AAPL": {
    "interval": 5,           # 更新間隔（分鐘）
    "backoff_factor": 2.0,   # 退避因子
    "max_backoff": 30        # 最大退避時間（分鐘）
  }
}
```

#### 6.3 Index Task (指數批量更新任務)

```python
INDEX_TASKS = {
    "sp500": asyncio.Task(...),      # S&P 500 指數成分更新任務
    "nasdaq100": asyncio.Task(...),  # Nasdaq-100 指數成分更新任務
    ...
}
```

**任務參數**（存儲在 `index_auto_registry.json`）：
```json
{
  "sp500": {
    "interval": 5,           # 更新間隔（分鐘）
    "concurrency": 4,        # 並發度
    "backoff_factor": 2.0,   # 退避因子
    "max_backoff": 30        # 最大退避時間（分鐘）
  }
}
```

---

## 資料檔案格式

### 1. CSV 資料檔案

**命名規範**：`{symbol}_short_term_with_lag3.csv`

**編碼**：UTF-8-BOM (`utf-8-sig`)

**範例檔案名**：
```
data/AAPL_short_term_with_lag3.csv
data/2330_short_term_with_lag3.csv
data/MSFT_short_term_with_lag3.csv
```

**欄位順序**（範例，實際列數 > 50）：
```
年月日,開盤價(元),最高價(元),最低價(元),收盤價(元),成交量(千股),
報酬率％,Gap％,振幅％,MA5,MA10,MA20,MA5差％,MA20差％,週幾,
成交量(千股)_log,成交量(千股)_rel20％,
收盤價(元)_lag1,收盤價(元)_lag2,...,報酬率％_lag1,報酬率％_lag2,...
```

**範例行**：
```csv
年月日,開盤價(元),收盤價(元),報酬率％,MA5,收盤價(元)_lag1,報酬率％_lag1
2024-01-15,100.5,103.0,2.48,101.2,100.8,1.52
2024-01-16,103.2,104.5,1.46,102.1,103.0,2.48
```

### 2. 模型檔案

**格式**：Pickle (`.pkl`)

**序列化庫**：`joblib`

**載入範例**：
```python
import joblib

pipeline = joblib.load("models/rf_pipeline.pkl")
threshold = joblib.load("models/rf_threshold.pkl")
```

### 3. Registry 檔案

**格式**：JSON (`.json`)

**編碼**：UTF-8

**範例**：`data/auto_registry.json`
```json
{
  "AAPL": {
    "interval": 5,
    "backoff_factor": 2.0,
    "max_backoff": 30
  },
  "2330": {
    "interval": 10,
    "backoff_factor": 1.5,
    "max_backoff": 20
  }
}
```

### 4. Last Update 檔案

**命名規範**：`{symbol}_last_update.txt`

**格式**：ISO 8601 時間戳

**範例**：`data/AAPL_last_update.txt`
```
2024-01-15T08:30:00.123456
```

---

## 關聯關係

### 資料流關係圖

```
Symbol
  │
  ├──> OHLCV (原始資料)
  │      │
  │      ├──> Feature (技術指標)
  │      │      │
  │      │      └──> Lag Features (滯後特徵)
  │      │
  │      └──> Label (目標變數)
  │
  └──> CSV 檔案 (完整特徵集)
         │
         ├──> Model (訓練) ──> Pipeline + Threshold
         │
         └──> Prediction (推理) ──> Probability + Label
```

### 實體關係圖 (ERD)

```
┌─────────────┐       1:N       ┌─────────────┐
│   Symbol    │──────────────>  │   OHLCV     │
└─────────────┘                 └─────────────┘
                                       │
                                       │ 1:1
                                       ▼
                                ┌─────────────┐
                                │   Feature   │
                                └─────────────┘
                                       │
                                       │ 1:1
                                       ▼
                                ┌─────────────┐
                                │    Label    │
                                └─────────────┘
                                       │
                                       │ N:1
                                       ▼
                                ┌─────────────┐
                                │    Model    │
                                └─────────────┘
```

---

## 資料生命週期

### 1. 資料獲取階段

```
Yahoo Finance API
       │
       ├──> 原始 OHLCV (DataFrame)
       │
       └──> 存儲到記憶體 (臨時)
```

### 2. 特徵工程階段

```
記憶體資料 (DataFrame)
       │
       ├──> 計算技術指標
       ├──> 生成滯後特徵
       ├──> 資料清洗 (dropna)
       │
       └──> 完整特徵集 (DataFrame)
```

### 3. 持久化階段

```
完整特徵集 (DataFrame)
       │
       ├──> 儲存爲 CSV (data/*.csv)
       └──> 記錄更新時間 (*_last_update.txt)
```

### 4. 模型訓練階段

```
CSV 檔案
       │
       ├──> 載入資料
       ├──> 切分資料集 (train/val/test)
       ├──> 特徵標準化
       ├──> 模型訓練
       ├──> 閾值最佳化
       │
       └──> 儲存模型 (models/*.pkl)
```

### 5. 推理階段

```
CSV 檔案 (最新行)
       │
       ├──> 載入預訓練模型
       ├──> 特徵對齊
       ├──> 特徵標準化 (使用訓練時的 scaler)
       ├──> 模型推理
       │
       └──> 回傳預測結果 (JSON)
```

---

## 資料品質保證

### 1. 資料驗證規則

| 驗證項 | 規則 | 處理方式 |
|--------|------|----------|
| 缺失值 | 檢查 NaN/None | 使用中位數填充 |
| 例外值 | Winsorization (1%-99% 分位) | 截斷到分位數邊界 |
| 重複日期 | 檢查日期唯一性 | 保留最後出現的記錄 |
| 負數價格 | price > 0 | 拒絕該股票資料 |
| 負數成交量 | volume >= 0 | 拒絕該股票資料 |

### 2. 資料清洗流程

```python
def clean_data(df: pd.DataFrame) -> pd.DataFrame:
    # 1. 移除重複日期
    df = df.drop_duplicates(subset=['年月日'], keep='last')
    
    # 2. 填充缺失值（使用中位數）
    for col in df.select_dtypes(include=[np.number]).columns:
        df[col].fillna(df[col].median(), inplace=True)
    
    # 3. Winsorization 例外值處理
    numeric_cols = ['報酬率％', 'Gap％', '振幅％', 'MA5差％', 'MA20差％']
    for col in numeric_cols:
        q_low = df[col].quantile(0.01)
        q_high = df[col].quantile(0.99)
        df[col] = df[col].clip(lower=q_low, upper=q_high)
    
    # 4. 移除滯後特徵生成後的 NaN 行
    df = df.dropna()
    
    return df
```

---

## 相關文檔

- [01_架構概覽.md](./01_架構概覽.md) - 系統架構與技術棧
- [03_業務規則.md](./03_業務規則.md) - 業務邏輯與特殊規則
- [04_術語詞彙.md](./04_術語詞彙.md) - 統一術語與命名約定
