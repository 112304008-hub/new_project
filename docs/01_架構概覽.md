# 01 架構概覽

## 專案簡介

**股價之神** 是一個基於 FastAPI 建構的股票短期預測系統，提供資料採集、特徵工程、模型訓練與推理的完整解決方案。

---

## 技術棧

### 後端框架
- **FastAPI 0.95.2** - 現代化非同步 Web 框架
- **Uvicorn 0.22.0** - ASGI 服務器
- **Python 3.11+** - 執行時環境

### 資料處理與機器學習
- **pandas 2.2.2** - 資料處理與分析
- **numpy 1.26.4** - 數值計算
- **scikit-learn 1.3.2** - 機器學習演算法
  - RandomForestClassifier - 隨機森林模型
  - LogisticRegression - 邏輯迴歸模型
  - StandardScaler - 特徵標準化
  - Pipeline - 模型管道
- **scipy 1.11.1** - 科學計算
- **statsmodels 0.14.0** - 統計建模與檢驗

### 資料源與外部服務
- **yfinance >=0.2.22** - Yahoo Finance 資料獲取
- **requests 2.31.0** - HTTP 請求庫

### 監控與可觀測性
- **prometheus-client 0.20.0** - Prometheus 指標導出

### 容器化與部署
- **Docker** - 容器化部署
- **Docker Compose** - 多容器編排
- **Caddy** - 自動 HTTPS 反向代理

### 測試
- **pytest 7.4.0** - 單元測試框架
- **httpx 0.27.2** - 非同步 HTTP 測試客戶端

---

## 系統架構

### 分層架構

```
┌─────────────────────────────────────────────────┐
│              前端層 (Frontend)                    │
│  template2.html - 簡易交互界面                    │
└─────────────────────────────────────────────────┘
                       │ HTTP/HTTPS
┌─────────────────────────────────────────────────┐
│            Web 服務層 (main.py)                  │
│  ┌───────────────────────────────────────────┐  │
│  │  中間件 (Middleware)                       │  │
│  │  - 日誌記錄 (Logging)                      │  │
│  │  - 速率限制 (Rate Limiting)                │  │
│  │  - API 密鑰驗證 (API Key Auth)             │  │
│  │  - 請求追蹤 (Request Tracing)              │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │  API 路由 (Routes)                         │  │
│  │  - 預測 API (/api/draw)                   │  │
│  │  - 資料建置 API (/api/build_*)            │  │
│  │  - 批量任務 API (/api/bulk_*)             │  │
│  │  - 自動更新 API (/api/auto/*)             │  │
│  │  - 診斷 API (/api/diagnostics)            │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │  後臺任務管理 (Background Tasks)           │  │
│  │  - Symbol Loop (單股票週期更新)            │  │
│  │  - Index Loop (指數成分批量更新)           │  │
│  │  - Bulk Build Worker (批量建置工作器)     │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                       │
┌─────────────────────────────────────────────────┐
│          業務邏輯層 (stock.py)                   │
│  - 資料獲取 (_fetch_ohlcv_yf)                   │
│  - 特徵工程 (_build_from_yfinance)              │
│  - 模型訓練 (train)                              │
│  - 預測推理 (predict, predict_latest)           │
└─────────────────────────────────────────────────┘
                       │
┌─────────────────────────────────────────────────┐
│              持久化層 (Storage)                  │
│  ┌─────────────┬─────────────┬─────────────┐   │
│  │   data/     │   models/   │  registry   │   │
│  │  CSV 資料    │  模型檔案    │  配置檔案    │   │
│  └─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────┘
```

### 資料流向

```
外部資料源 (Yahoo Finance, Wikipedia)
         │
         ▼
  資料獲取 (yfinance API)
         │
         ▼
  特徵工程 (lag features, technical indicators)
         │
         ▼
  CSV 存儲 (data/*_short_term_with_lag3.csv)
         │
         ▼
  模型訓練 (離線/手動)
         │
         ▼
  模型持久化 (models/*_pipeline.pkl, *_threshold.pkl)
         │
         ▼
  模型載入 & 推理
         │
         ▼
  預測結果 (JSON Response)
```

---

## 模塊劃分

### 1. Web 服務模塊 (`main.py`)

**職責**：
- HTTP 請求處理
- 路由定義與請求分發
- 中間件管理（日誌、限流、鑑權）
- 後臺任務調度
- 監控指標導出

**核心組件**：
```python
FastAPI 應用實例
├── Middleware 中間件棧
│   ├── metrics_and_logging_middleware (指標與日誌)
│   ├── rate_limit_check (速率限制)
│   └── api_key_auth (API 密鑰驗證)
├── Routes 路由組
│   ├── / (前端頁面)
│   ├── /api/draw (預測介面)
│   ├── /api/build_* (資料建置)
│   ├── /api/bulk_* (批量任務)
│   ├── /api/auto/* (自動更新)
│   └── /health, /metrics, /version (監控)
└── Background Tasks 後臺任務
    ├── SYMBOL_TASKS (符號任務字典)
    ├── INDEX_TASKS (指數任務字典)
    └── BULK_TASKS (批量任務字典)
```

### 2. 業務邏輯模塊 (`stock.py`)

**職責**：
- 資料獲取（Yahoo Finance API 封裝）
- 特徵工程（技術指標計算、滯後特徵生成）
- 模型訓練（隨機森林、邏輯迴歸）
- 預測推理（模型載入、特徵對齊、推理執行）

**核心函式**：
```python
predict(csv_path, model, symbol) -> Dict
├── _resolve_csv_path() - 路徑解析
├── _build_y() - 目標變數建構
├── 特徵預處理
│   ├── 缺失值填充
│   └── 標準化
└── 模型推理
    ├── 管道載入 (joblib)
    ├── 特徵對齊
    └── 概率預測

train(csv_path, models_to_train) -> Dict
├── 資料載入與切分
├── 特徵工程
├── 模型訓練 (RF/LR)
├── 閾值最佳化 (_best_threshold)
└── 模型持久化

_build_from_yfinance(symbol, out_csv) -> DataFrame
├── _fetch_ohlcv_yf() - OHLCV 資料獲取
├── 技術指標計算
│   ├── 收益率、Gap、振幅
│   ├── 移動平均線 (MA5, MA10, MA20)
│   └── 成交量指標
├── 滯後特徵生成 (lag 1-5)
└── 資料清洗與存儲
```

### 3. 前端模塊 (`template2.html`)

**職責**：
- 用戶交互界面
- 預測結果展示
- 簡單的抽籤動畫效果

### 4. 測試模塊 (`tests/`)

**職責**：
- 單元測試
- 整合測試
- API 端到端測試

---

## 關鍵設計決策

### 1. 模型訓練與推理分離

**決策**：模型訓練不在生產容器中執行，僅提供推理服務。

**理由**：
- 訓練是 CPU/GPU 密集型任務，不適合在 Web 服務容器中執行
- 避免訓練過程影響推理服務的穩定性
- 支持離線訓練、版本控制、AB 測試

**實作**：
- 訓練在本地或專用訓練環境進行
- 訓練產物（`*_pipeline.pkl`, `*_threshold.pkl`）通過掛載或烤入鏡像方式提供
- 推理服務只讀取預訓練模型檔案

### 2. 非同步後臺任務架構

**決策**：使用 Python asyncio 實作後臺任務，而非 Celery 等外部佇列。

**理由**：
- 簡化架構，無需額外的消息佇列（Redis/RabbitMQ）
- 適合中小規模任務調度需求
- 充分利用 FastAPI 的非同步特性

**實作**：
```python
# Symbol Loop - 單股票週期更新
async def _symbol_loop(symbol, interval_min, backoff_factor, max_backoff_min)

# Index Loop - 指數成分批量更新
async def _index_loop(index, interval_min, concurrency, backoff_factor, max_backoff_min)

# Bulk Build Worker - 批量建置工作器
async def _bulk_build_worker(symbols, concurrency, task_id)
```

### 3. 指數式退避重試策略

**決策**：對失敗的資料獲取操作採用指數式退避（Exponential Backoff）。

**理由**：
- Yahoo Finance 可能存在速率限制
- 避免在短時間內大量重試，造成 IP 被封禁
- 自動復原機制，無需人工介入

**實作**：
```python
consecutive_failures = 0
base_interval = interval_min

while True:
    try:
        # 執行資料更新
        success = update_data()
        if success:
            consecutive_failures = 0
            sleep_time = base_interval
    except Exception:
        consecutive_failures += 1
        sleep_time = min(
            max_backoff_min,
            base_interval * (backoff_factor ** consecutive_failures)
        )
    await asyncio.sleep(sleep_time * 60)
```

### 4. 特徵對齊機制

**決策**：在推理時動態對齊特徵，確保與訓練時特徵一致。

**理由**：
- 不同資料源的特徵可能有差異
- 模型更新後特徵集可能變化
- 避免 Feature Mismatch 導致的推理失敗

**實作**：
```python
# 推理時檢查並對齊特徵
expected_features = pipeline.feature_names_in_
missing = [f for f in expected_features if f not in X_all.columns]
for f in missing:
    X_all[f] = 0.0  # 缺失特徵填充爲 0

# 按訓練時的特徵順序選擇
X_inference = X_all[expected_features]
```

### 5. 容器化部署策略

**決策**：提供開發模式（掛載）和生產模式（烤入）兩種部署方式。

**理由**：
- 開發模式支持熱重載，提升開發效率
- 生產模式確保環境一致性，避免掛載點權限問題
- 支持離線交付（docker save/load）

**實作**：
- `docker-compose.yml` - 開發模式（掛載程式碼、資料、模型）
- `docker-compose.prod.yml` - 生產模式（烤入資料和模型，Caddy 自動 HTTPS）

### 6. 監控與可觀測性

**決策**：整合 Prometheus 指標導出，提供健康檢查與版本信息。

**理由**：
- 支持容器編排平臺的健康檢查（Kubernetes, Docker Compose）
- 便於整合到監控系統（Prometheus + Grafana）
- 提供效能分析與故障排查依據

**實作**：
```python
# Prometheus 指標
HTTP_REQ_COUNT = Counter("app_http_requests_total", ...)
HTTP_REQ_LATENCY = Histogram("app_http_request_duration_seconds", ...)
BACKGROUND_TASKS_GAUGE = Gauge("app_background_tasks", ...)
MODELS_READY_GAUGE = Gauge("app_models_ready", ...)
DATA_READY_GAUGE = Gauge("app_data_ready", ...)

# 健康檢查端點
@app.get('/health')
def health():
    return {
        "status": "ok",
        "models_ready": check_models(),
        "data_ready": check_data(),
        "versions": {...}
    }
```

---

## 部署架構

### 開發環境

```
本地機器
├── Python 虛擬環境 (.venv)
├── 源程式碼 (main.py, stock.py)
├── 資料目錄 (data/)
├── 模型目錄 (models/)
└── Uvicorn 直接執行
```

### 生產環境（Docker Compose）

```
Docker Host
├── Caddy 容器 (反向代理, 自動 HTTPS)
│   └── 端口: 80, 443
├── Web 容器 (FastAPI 應用)
│   └── 內部端口: 8000
└── DDNS 容器 (可選, 動態 DNS 更新)
    └── DuckDNS / Cloudflare
```

### 生產環境（Kubernetes）

```
Kubernetes 集羣
├── Ingress (HTTPS 終止)
├── Service (負載均衡)
├── Deployment (應用 Pod)
│   ├── Pod 1 (FastAPI 容器)
│   ├── Pod 2 (FastAPI 容器)
│   └── Pod N (水平擴展)
└── PersistentVolume (資料與模型存儲)
```

---

## 效能特徵

### 推理效能
- **延遲**：典型 50-200ms (冷啟動首次推理 < 1s)
- **吞吐量**：單實例約 100-200 RPS (取決於特徵複雜度)
- **記憶體佔用**：約 200-500 MB (含模型)

### 資料建置效能
- **單股票**：約 5-15 秒 (取決於網路與歷史資料量)
- **批量建置 (S&P 500)**：約 30-60 分鐘 (並發度 4-8)

### 後臺任務
- **Symbol Loop**：輕量級，單股票約 10-20 MB 記憶體
- **Index Loop**：中等開銷，500 檔約 100-200 MB 記憶體

---

## 安全考慮

### 1. API 訪問控制
- 可選 API Key 認證（環境變數 `API_KEY`）
- 基於記憶體的速率限制（可配置 `RATE_LIMIT_PER_MIN`）

### 2. 資料安全
- 敏感環境變數通過 `.env` 檔案管理
- `.env` 檔案在 `.gitignore` 中排除

### 3. 容器安全
- 使用 `python:3.11-slim` 精簡基礎鏡像
- 定期更新依賴，修復已知漏洞
- 建議使用 `trivy` 掃描鏡像漏洞

### 4. 網路安全
- 生產環境強制 HTTPS (Caddy 自動 Let's Encrypt)
- 可配置反向代理 (Nginx/Caddy) 隔離內部服務
- 建議配置防火牆，僅開放必要端口

---

## 擴展性考慮

### 水平擴展
- **無狀態設計**：API 服務無狀態，支持多實例部署
- **共享存儲**：需使用 NFS/S3 等共享存儲掛載 `data/` 和 `models/`
- **分佈式限流**：多實例需替換爲 Redis 等外部限流方案

### 垂直擴展
- **CPU 密集型**：資料建置和模型推理受益於多核 CPU
- **記憶體需求**：與模型大小和後臺任務數量正相關
- **存儲需求**：與歷史資料和模型版本數量正相關

---

## 技術債務

### 當前限制
1. **記憶體限流**：多實例部署時限流不共享
2. **檔案存儲**：模型和資料使用本地檔案系統，不支持分佈式
3. **任務持久化**：後臺任務狀態僅在記憶體，重啓後丟失（需依賴 registry 復原）
4. **單執行緒訓練**：模型訓練未使用分佈式，大資料集耗時長

### 改進方向
1. 引入 Redis 實作分佈式限流與任務佇列
2. 遷移到 S3/MinIO 等物件存儲
3. 整合 MLflow 實作模型版本管理
4. 引入 Celery 支持分佈式任務調度

---

## 相關文檔

- [02_資料模型.md](./02_資料模型.md) - 核心資料結構與欄位定義
- [03_業務規則.md](./03_業務規則.md) - 業務邏輯與特殊規則
- [04_術語詞彙.md](./04_術語詞彙.md) - 統一術語與命名約定
- [05_開發規範.md](./05_開發規範.md) - 程式碼風格與開發流程
- [06_常見問題.md](./06_常見問題.md) - FAQ 與故障排查
